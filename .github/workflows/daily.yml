name: Daily runs
on:
  push:
    paths:
    - './.github/workflows/daily.yml'
  schedule:
    - cron: '0 5 * * *'

jobs:
  linux-daily-unittests:
    name: "Linux - daily unit tests - Python 3.9 ${{ matrix.RUN_VERSION }}"
    runs-on: ubuntu-latest
    env:
      CI: True
    strategy:
      fail-fast: false
      matrix:
        # run once with nightlies, and once with normal dependencies
        RUN_VERSION: ['nightly', '']
    steps:
      - name: Pull image
        run: docker pull condaforge/mambaforge:latest
      - name: Checkout branch
        uses: actions/checkout@v2.3.5
        with:
          ref: ${{ github.head_ref }}
      - name: Run CI inside of container
        uses: ./.github/actions/daily_unittests
        with:
          python_version: '3.9'
          pandas_version: ${{ matrix.RUN_VERSION }}
          numpy_version: ${{ matrix.RUN_VERSION }}
          scikit_version: ${{ matrix.RUN_VERSION }}
          scipy_version: ${{ matrix.RUN_VERSION }}
          tabmat_version: ${{ matrix.RUN_VERSION }}
      # - name: Issue on failure
      #   uses: actions/github-script@v5
      #   if: ${{ failure() }}
      #   with:
      #     script: |
      #       github.rest.issues.listForRepo({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         state: "open",
      #         labels: "[bot] Daily run"
      #       }).then((issues) => {
      #         if (issues.data.length === 0){
      #           github.rest.issues.create({
      #             owner: context.repo.owner,
      #             repo: context.repo.repo,
      #             title: "Daily run failure: Unit tests",
      #             body: "The daily unit tests failed. See https://github.com/Quantco/glum/actions/runs/${{ github.run_id }} for details.",
      #             assignees: ["MarcAntoineSchmidtQC", "lbittarello"],
      #             labels: ["[bot] Daily run"]
      #           })
      #         }
      #       });